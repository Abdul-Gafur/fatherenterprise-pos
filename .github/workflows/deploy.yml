name: Deploy to cPanel

on:
  push:
    branches: [ main ]

jobs:
  web-deploy:
    name: ðŸŽ‰ Build & Deploy
    runs-on: ubuntu-latest

    steps:
    - name: ðŸšš Get latest code
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick
        coverage: none

    - name: ï¿½ Create Storage Directories & Env
      run: |
        mkdir -p storage/framework/cache
        mkdir -p storage/framework/sessions
        mkdir -p storage/framework/views
        mkdir -p bootstrap/cache
        cp .env.example .env

    - name: ï¿½ðŸ“¦ Install Composer Dependencies
      run: composer install --no-ansi --no-interaction --no-progress --no-dev --optimize-autoloader

    - name: ðŸ”‘ Install SSH Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ðŸ“‚ Sync Files (Rsync)
      run: |
        rsync -avz --delete \
          -e "ssh -o StrictHostKeyChecking=no" \
          --exclude='.git*' \
          --exclude='node_modules' \
          --exclude='.env' \
          --exclude='tests' \
          --exclude='.github' \
          --exclude='.editorconfig' \
          ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/sites/23a/4/4bebba9906/public_html/fatherentpos_new

    - name: ðŸš€ Run Post-Deployment Commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "Starting Post-Deployment Script..."
          
          # 1. Force the shell to load the environment paths
          export PATH=/usr/local/bin:/usr/bin:/bin:/usr/php82/usr/bin:$PATH
          
          # 2. Change directory
          cd /home/sites/23a/4/4bebba9906/public_html/fatherentpos_new
          echo "Current Directory: $(pwd)"
          
          
          # 3. Find binaries
          PHP_BIN=$(command -v php82 || command -v php)
          echo "PHP Binary: $PHP_BIN"

          # 4. PHP-based Backup Script (More robust)
          echo "Creating backup script..."
          cat <<EOF > deploy_backup.php
          <?php
          if (file_exists(__DIR__ . '/vendor/autoload.php')) {
              require __DIR__ . '/vendor/autoload.php';
              try {
                  \$app = require_once __DIR__ . '/bootstrap/app.php';
                  \$kernel = \$app->make(Illuminate\Contracts\Console\Kernel::class);
                  \$kernel->bootstrap();
                  
                  \$config = config('database.connections.mysql');
                  // Fallback to env if config is null (rare)
                  if (!\$config) {
                      echo "Could not load database config.\n";
                      exit(1);
                  }

                  \$host = \$config['host'] ?? '127.0.0.1';
                  \$port = \$config['port'] ?? '3306';
                  \$user = \$config['username'];
                  \$pass = \$config['password'];
                  \$db = \$config['database'];
                  
                  \$dir = __DIR__ . '/storage/backups';
                  if (!is_dir(\$dir)) {
                      mkdir(\$dir, 0755, true);
                  }
                  
                  \$fileName = 'backup_' . date('Ymd_His') . '.sql';
                  \$filePath = \$dir . '/' . \$fileName;
                  
                  echo "Backing up database '\$db' to '\$filePath'...\n";
                  
                  // Construct command
                  // --no-tablespaces requires PROCESS privilege, usually better to include it if possible, 
                  // but if it fails, we assume standard user access. 
                  // Using --no-tablespaces is safer for shared hosting.
                  \$cmd = "mysqldump -h '{\$host}' -P '{\$port}' -u '{\$user}' -p'{\$pass}' --no-tablespaces '{\$db}' > '{\$filePath}' 2>&1";
                  
                  exec(\$cmd, \$output, \$return);
                  
                  if (\$return === 0) {
                      echo "âœ… Backup successful!\n";
                  } else {
                      echo "âŒ Backup failed (Return Code: \$return).\n";
                      echo "Command Output:\n";
                      print_r(\$output);
                      
                      // Fallback: Try without single quotes for host/port (sometimes shell parsing issues)
                      echo "Retrying locally...\n";
                      \$cmd2 = "mysqldump -u '{\$user}' -p'{\$pass}' --no-tablespaces '{\$db}' > '{\$filePath}' 2>&1";
                      exec(\$cmd2, \$output2, \$return2);
                      if (\$return2 === 0) {
                          echo "âœ… Retry successful!\n";
                      } else {
                           echo "âŒ Retry failed too.\n";
                           print_r(\$output2);
                      }
                  }
                  
              } catch (\Exception \$e) {
                  echo "Error: " . \$e->getMessage() . "\n";
              }
          } else {
              echo "Vendor autoload not found. Skipping backup.\n";
          }
          EOF
          
          # Execute and remove
          $PHP_BIN deploy_backup.php
          rm -f deploy_backup.php

          # 5. Run Artisan commands
          echo "Running Artisan commands..."
          $PHP_BIN artisan migrate --force
          $PHP_BIN artisan optimize:clear
          $PHP_BIN artisan config:cache
          $PHP_BIN artisan route:cache
          $PHP_BIN artisan view:cache
          $PHP_BIN artisan storage:link
          echo "Deployment Complete."
